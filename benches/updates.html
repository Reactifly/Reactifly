<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Patching HTML</title>
		<style>
			.hello {
				color: red;
			}

			.bye {
				color: blue;
			}
		</style>
	</head>
	<body>
		<div id="root"></div>
		<script type="text/javascript" src="../dist/bundle.js"></script>
		<script type="module">
			// import afterFrame from "../node_modules/afterframe/dist/afterframe.module.js";

			export const measureName = 'duration';

			export function measureMemory()
			{
				if ('gc' in window && 'memory' in performance)
				{
					// Report results in MBs
					window.gc();

					window.usedJSHeapSize = performance.memory.usedJSHeapSize / 1e6;

				}
				else
				{
					window.usedJSHeapSize = 0;
				}
			}

			export function markRunStart(runId)
			{
				performance.mark(`run-${runId}-start`);
			}

			let staticPromise = Promise.resolve();
			export function markRunEnd(runId)
			{
				return staticPromise.then(() =>
				{
					performance.mark(`run-${runId}-end`);
					performance.measure(
						`run-${runId}`,
						`run-${runId}-start`,
						`run-${runId}-end`
					);
				});
			}

			export function getRowIdSel(index)
			{
				return `tbody > tr:nth-child(${index}) > td:first-child`;
			}

			export function getRowLinkSel(index)
			{
				return `tbody > tr:nth-child(${index}) > td:nth-child(2) > a`;
			}

			/**
			 * @param
			 {string} selector
			 * @returns
			 {Element}
			 */
			export function getBySelector(selector)
			{
				const element = document.querySelector(selector);

				if (element == null)
				{
					throw new Error(`Could not find element matching selector: ${selector}`);
				}

				return element;
			}

			export function testElement(selector)
			{
				const testElement = document.querySelector(selector);

				if (testElement == null)
				{
					throw new Error(
						'Test failed. Rendering after one paint was not successful'
					);
				}
			}

			export function testElementText(selector, expectedText)
			{
				const elm = document.querySelector(selector);
				if (elm == null)
				{
					throw new Error('Could not find element matching selector: ' + selector);
				}

				if (elm.textContent != expectedText)
				{
					throw new Error(
						`Element did not have expected text. Expected: '${expectedText}' Actual: '${elm.textContent}'`
					);
				}
			}

			export function testElementTextContains(selector, expectedText)
			{
				const elm = getBySelector(selector);
				if (!elm.textContent.includes(expectedText))
				{
					throw new Error(
						`Element did not include expected text. Expected to include: '${expectedText}' Actual: '${elm.textContent}'`
					);
				}
			}

			let count = 0;
			const channel = new MessageChannel();
			const callbacks = new Map();
			channel.port1.onmessage = e =>
			{
				let id = e.data;
				let fn = callbacks.get(id);
				callbacks.delete(id);
				fn();
			};
			let pm = function(callback)
			{
				let id = ++count;
				callbacks.set(id, callback);
				this.postMessage(id);
			}.bind(channel.port2);

			export function nextTick()
			{
				return new Promise(r => pm(r));
			}

			export function mutateAndLayoutAsync(mutation, times = 1)
			{
				return new Promise(resolve =>
				{
					requestAnimationFrame(() =>
					{
						for (let i = 0; i < times; i++)
						{
							mutation(i);
						}
						pm(resolve);
					});
				});
			}

			let h = Reactifly.h;

			export const sleep = ms => new Promise(r => setTimeout(r, ms));

			const state = {
				msg: 'hello',
				list: new Array(1000).fill(0).map((_, i) => ({
					i,
					text: 'foobar' + i
				}))
			};

			let counter = 0;

			function App()
			{
				return h(
					'div',
					{ id: 'app' },
					h('p', null, '> ', ++counter, ' <'),
					h('p', null, state.msg),
					...state.list.map((obj, i) =>
						h(
							'div',
							{ key: i, title: state.msg + i },
							h('span', { className: state.msg }, obj.text),
							h('span', { className: 'baz' }, 'one'),
							h('span', { className: 'qux' }, 'two'),
							h(
								'div',
								null,
								h('span', { className: 'qux' }, 'three'),
								h('span', { className: 'qux' }, 'four'),
								h('span', { className: 'baz' }, 'five'),
								h(
									'div',
									null,
									h('span', { className: 'qux' }, 'six'),
									h('span', { className: 'baz' }, 'seven'),
									h('span', { className: state.msg }, 'eight')
								)
							)
						)
					)
				);
			}

			const root = Reactifly.createRoot(document.getElementById('root'));

			const p = performance.now();
			root.render(App);
			console.log(`mount: ${(performance.now() - p).toFixed(2)}ms`);

			const patchResults = [];

			function runPatch() {

				const s = performance.now();
				state.msg = state.msg === 'hello' ? 'bye' : 'hello';
				state.list[0].text = state.msg;
				root.render(App);
				patchResults.push(performance.now() - s);
			}

			async function warmup() {
				const count = 100;

				for (let i = 0; i < count; i++) {
					runPatch();
					await new Promise(r => requestAnimationFrame(r));
				}

				let fastest = Infinity;
				const total = patchResults.reduce((all, cur) => {
				if (cur < fastest) {
					fastest = cur;
				}
				 	return all + cur;
				}, 0);

				console.log(`${count} runs average: ${(total / count).toFixed(2)}ms`);
				console.log(`fastest run: ${fastest.toFixed(2)}ms`);
			}

			warmup().then(async () => {
				performance.mark('start');
				runPatch();
				await new Promise(r => requestAnimationFrame(r));
				performance.mark('stop');
				performance.measure(measureName, 'start', 'stop');

				measureMemory();
			});
		</script>
	</body>
</html>